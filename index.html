<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <link rel="icon" href="data:,">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Users & Posts</title>
    <script src="https://cdn.jsdelivr.net/npm/graphql@16.6.0/graphql.min.js"></script>
</head>
<body>
    <h1>Users List</h1>
    <table border="1">
        <thead>
            <tr>
                <th>ID</th>
                <th>Name</th>
                <th>Email</th>
            </tr>
        </thead>
        <tbody id="users-table"></tbody>
    </table>

    <h1>Posts List</h1>
    <table border="1">
        <thead>
            <tr>
                <th>User ID</th>
                <th>Title</th>
                <th>Content</th>
            </tr>
        </thead>
        <tbody id="posts-table"></tbody>
    </table>

    <script type="module">
        import { ApolloClient, InMemoryCache, gql, HttpLink, split } from "https://cdn.jsdelivr.net/npm/@apollo/client/core/index.min.js";
        import { GraphQLWsLink } from "https://cdn.jsdelivr.net/npm/@apollo/client/link/subscriptions/index.min.js";
        import { createClient } from "https://cdn.jsdelivr.net/npm/graphql-ws/umd/index.min.js";
        import { getMainDefinition } from "https://cdn.jsdelivr.net/npm/@apollo/client/utilities/index.min.js";

        const HTTP_URI = "http://localhost:4001/graphql"; // Users API
        const WS_URI = "ws://localhost:4001/graphql"; // Users WebSocket

        const POSTS_HTTP_URI = "http://localhost:4002/graphql"; // Posts API
        const POSTS_WS_URI = "ws://localhost:4002/graphql"; // Posts WebSocket

        // HTTP Link for Queries & Mutations
        const httpLink = new HttpLink({ uri: HTTP_URI });
        const postsHttpLink = new HttpLink({ uri: POSTS_HTTP_URI });

        // WebSocket Link for Subscriptions
        const wsLink = new GraphQLWsLink(createClient({ url: WS_URI }));
        const postsWsLink = new GraphQLWsLink(createClient({ url: POSTS_WS_URI }));

        // Split Links
        const link = split(
            ({ query }) => {
                const definition = getMainDefinition(query);
                return definition.kind === "OperationDefinition" && definition.operation === "subscription";
            },
            wsLink,
            httpLink
        );

        const postsLink = split(
            ({ query }) => {
                const definition = getMainDefinition(query);
                return definition.kind === "OperationDefinition" && definition.operation === "subscription";
            },
            postsWsLink,
            postsHttpLink
        );

        // Apollo Clients
        const client = new ApolloClient({ link, cache: new InMemoryCache() });
        const postsClient = new ApolloClient({ link: postsLink, cache: new InMemoryCache() });

        // GraphQL Queries
        const USERS_QUERY = gql`
            query GetUsers {
                users {
                    id
                    name
                    email
                }
            }
        `;

        const POSTS_QUERY = gql`
            query GetPosts {
                posts {
                    id
                    title
                    content
                    userId
                }
            }
        `;

        // GraphQL Subscriptions
        const USER_ADDED_SUBSCRIPTION = gql`
            subscription OnUserAdded {
                userAdded {
                    id
                    name
                    email
                }
            }
        `;

        const POST_ADDED_SUBSCRIPTION = gql`
            subscription OnPostAdded {
                postAdded {
                    id
                    title
                    content
                    userId
                }
            }
        `;

        function updateUsersTable(users) {
            const tableBody = document.getElementById("users-table");
            tableBody.innerHTML = "";
            users.forEach(user => {
                const row = document.createElement("tr");
                row.innerHTML = `<td>${user.id}</td><td>${user.name}</td><td>${user.email}</td>`;
                tableBody.appendChild(row);
            });
        }

        function updatePostsTable(posts) {
            const tableBody = document.getElementById("posts-table");
            tableBody.innerHTML = "";
            posts.forEach(post => {
                const row = document.createElement("tr");
                row.innerHTML = `<td>${post.userId}</td><td>${post.title}</td><td>${post.content}</td>`;
                tableBody.appendChild(row);
            });
        }

        async function fetchUsers() {
            try {
                const { data } = await client.query({ query: USERS_QUERY });
                updateUsersTable(data.users);
            } catch (error) {
                console.error("Error fetching users:", error);
            }
        }

        async function fetchPosts() {
            try {
                const { data } = await postsClient.query({ query: POSTS_QUERY });
                updatePostsTable(data.posts);
            } catch (error) {
                console.error("Error fetching posts:", error);
            }
        }

        // Subscribe to new users
        const userSubscription = client.subscribe({ query: USER_ADDED_SUBSCRIPTION }).subscribe({
            next({ data }) {
                console.log("New User Added:", data.userAdded);
                const tableBody = document.getElementById("users-table");
                const row = document.createElement("tr");
                row.innerHTML = `<td>${data.userAdded.id}</td><td>${data.userAdded.name}</td><td>${data.userAdded.email}</td>`;
                tableBody.appendChild(row);
            },
            error(err) {
                console.error("Subscription error:", err);
            }
        });

        // Subscribe to new posts
        const postSubscription = postsClient.subscribe({ query: POST_ADDED_SUBSCRIPTION }).subscribe({
            next({ data }) {
                console.log("New Post Added:", data.postAdded);
                const tableBody = document.getElementById("posts-table");
                const row = document.createElement("tr");
                row.innerHTML = `<td>${data.postAdded.userId}</td><td>${data.postAdded.title}</td><td>${data.postAdded.content}</td>`;
                tableBody.prepend(row);
            },
            error(err) {
                console.error("Post Subscription error:", err);
            }
        });

        window.addEventListener("beforeunload", () => {
            userSubscription.unsubscribe();
            postSubscription.unsubscribe();
        });

        fetchUsers();
        fetchPosts();
    </script>
</body>
</html>
